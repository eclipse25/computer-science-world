## 세마포어 (Semaphore)

### 1. 세마포어
세마포어(Semaphore)는 운영체제에서 공유 자원(Shared Resource)의 접근을 제어하기 위한 동기화(Synchronization) 기법이다.  
멀티스레드 또는 멀티프로세스 환경에서 경쟁 상태(Race Condition)를 방지하고, 일정 개수의 스레드 또는 프로세스만 공유 자원에 접근할 수 있도록 관리한다.

세마포어는 **내부적으로 정수 값(카운터)과 대기 중인 프로세스 목록을 관리하며**, 특정 연산을 통해 동작한다.

<br>

### 2. 세마포어의 동작 방식 (P 연산과 V 연산)

세마포어는 **P 연산(Wait, 감소)과 V 연산(Signal, 증가)** 을 통해 동작한다.

#### 1) P 연산 (Wait, 감소)
- 프로세스(또는 스레드)가 공유 자원에 접근하려고 할 때, 세마포어 값을 1 감소한다.
- 세마포어 값이 0이면, 해당 프로세스는 **대기 상태**가 되어야 한다.

#### 2) V 연산 (Signal, 증가)
- 프로세스(또는 스레드)가 공유 자원 사용을 마치면, 세마포어 값을 1 증가시킨다.
- 대기 중인 프로세스가 있으면, 하나의 프로세스를 깨워 실행시킨다.

#### 3) 세마포어의 동작 흐름
1. 세마포어의 초기 값은 공유 자원의 개수와 동일하게 설정된다.
2. 프로세스가 공유 자원에 접근하려고 하면 P 연산을 수행하여 세마포어 값을 감소시킨다.
3. 세마포어 값이 0보다 크면, 즉 자원이 남아 있으면 접근이 허용된다.
4. 자원이 모두 사용 중이라면(세마포어 값이 0이면), 프로세스는 대기 상태로 전환된다.
5. 자원을 사용한 프로세스가 작업을 마치면 V 연산을 수행하여 세마포어 값을 증가시킨다.
6. 대기 중인 프로세스가 있으면, 세마포어가 해당 프로세스를 깨워 실행시킨다.

#### 운영체제에서의 세마포어 구조 예시 (리눅스 커널)

- 운영체제에서 세마포어는 커널(Kernel) 이 관리하는 추상적인 동기화 객체로 구현
- 리눅스에서는 `sem_t` 구조체를 사용하고, 내부적으로 다음과 같은 데이터들을 가진다. 

    ```c
    typedef struct {
        int value;       // 현재 세마포어 값 (카운터)
        queue_t waiters; // 대기 중인 프로세스 목록 (FIFO 큐)
    } sem_t;
    ```

<br>

### 3. 세마포어의 종류

#### 1) 이진 세마포어 (Binary Semaphore, Mutex)
- 값이 `0` 또는 `1` 만 가질 수 있으며, 뮤텍스(Mutex)와 유사한 개념이다.
    - 0 (잠김, Locked) → 현재 자원을 다른 프로세스가 사용 중이므로, 새로운 프로세스는 접근할 수 없음.
    - 1 (열림, Unlocked) → 현재 자원을 사용 중인 프로세스가 없으므로, 새로운 프로세스가 접근 가능.
- 한 번에 하나의 스레드만 공유 자원에 접근 가능하다.

#### 2) 카운팅 세마포어 (Counting Semaphore)
- 값이 `0` 이상의 정수값을 가질 수 있으며, 최대 `N`개의 스레드가 동시에 접근 가능하다.
- 일정 개수의 프로세스가 동시에 공유 자원에 접근할 수 있도록 제어할 때 사용된다.

<br>

### 4. 세마포어 vs 뮤텍스 (Mutex)

| 비교 항목 | 세마포어 (Semaphore) | 뮤텍스 (Mutex) |
|----------|----------------------|---------------|
| 개수 | N개까지 가능 | 1개 (Binary Semaphore) |
| 공유 방식 | 프로세스 간 공유 가능 | 한 프로세스 내에서만 사용 |
| 사용 목적 | 일정 개수의 스레드/프로세스 제한 | 단 하나의 스레드만 접근 허용 |
| 소유권 | 소유권 없음 (누구나 해제 가능) | 소유권 있음 (락을 건 스레드만 해제 가능) |

<br>

### 5. 운영체제에서 세마포어의 역할

#### 1) 프로세스 동기화 (Process Synchronization)
운영체제에서 여러 프로세스를 순서대로 실행하도록 제어하는 데 사용된다.  
한 프로세스가 특정 작업을 완료해야만 다음 프로세스가 실행되도록 동기화할 때 활용된다.

#### 2) 상호 배제 (Mutual Exclusion, Mutex)
한 번에 하나의 프로세스만 공유 자원에 접근하도록 제한하는 역할을 한다.  
이를 통해 여러 프로세스가 동시에 자원을 수정하여 발생하는 충돌을 방지할 수 있다.

#### 3) 교착 상태 (Deadlock) 방지
세마포어를 잘못 사용하면 프로세스들이 서로의 자원을 기다리면서 무한 대기 상태(Deadlock)가 발생할 수 있다.  
운영체제에서는 타임아웃 설정, 세마포어 순서 요청 등을 통해 데드락을 방지한다.

<br>

### 6. 세마포어가 사용되는 예시
- 데이터베이스 커넥션 풀 관리 (동시 접근 가능한 DB 연결 수 제한)
- 네트워크 서버의 최대 동시 접속 수 제한 (예: 웹 서버에서 최대 100개 연결 허용)
- 멀티 프로세스 환경에서 공유 자원 보호 (특정 파일을 한 번에 3개 프로세스만 접근 가능하도록 설정)

<br>

### 7. 정리
- 세마포어는 운영체제에서 공유 자원의 접근을 제어하는 동기화 기법이다.
- **P 연산(Wait)과 V 연산(Signal)을 통해 공유 자원 접근을 제어** 한다.
- 이진 세마포어(Binary Semaphore)는 Mutex와 동일한 개념이다.
- 카운팅 세마포어(Counting Semaphore)는 `N`개까지 동시 접근을 허용한다.
- 교착 상태(Deadlock) 방지에 중요한 역할을 한다.
- 운영체제에서 멀티스레드, 멀티프로세스 환경에서 필수적인 개념이다.

<br>

### 8. 언제 세마포어를 사용해야 할까?
- N개의 스레드만 동시에 실행할 수 있도록 제한해야 하는 경우
- 하나의 공유 자원에 여러 프로세스가 접근할 경우
- 여러 개의 프로세스가 순차적으로 실행되어야 할 때
- 멀티스레드 환경에서는 뮤텍스가 더 많이 사용되며, 멀티프로세스 환경에서는 세마포어가 더 많이 사용된다.
